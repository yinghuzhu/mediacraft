# MediaCraft 异步任务管理系统实现任务列表

## 实现概述

基于Cookie用户识别和文件系统存储的异步任务管理系统，让用户可以提交任务后关闭浏览器，稍后回来查看处理结果。

## 实现任务清单

### 阶段1: 用户身份管理系统 (1天)

#### 1.1 用户识别中间件
- [ ] 创建用户识别中间件 `middleware/user_middleware.py`
  - 检查Cookie中的user_id
  - 生成新用户ID（UUID）
  - 设置Cookie（30天过期）
  - 创建用户数据文件
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

#### 1.2 用户管理器
- [ ] 创建用户管理器 `core/user_manager.py`
  - 用户数据的CRUD操作
  - 用户任务关联管理
  - 用户会话更新
  - _需求: 1.1, 1.2, 1.3_

#### 1.3 用户模型
- [ ] 创建用户模型 `models/user.py`
  - User类定义
  - 用户数据序列化/反序列化
  - 用户数据验证
  - _需求: 1.1, 1.2_

#### 1.4 用户API
- [ ] 创建用户API `api/user.py`
  - GET /api/user/info - 获取用户信息
  - GET /api/user/tasks - 获取用户任务列表
  - _需求: 3.1, 3.5_

### 阶段2: 异步任务管理系统 (2天)

#### 2.1 任务管理器
- [ ] 创建任务管理器 `core/task_manager.py`
  - 任务创建和状态管理
  - 任务与用户关联
  - 任务数据持久化
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

#### 2.2 任务队列系统
- [ ] 创建任务队列 `core/task_queue.py`
  - 基于ThreadPoolExecutor的任务队列
  - 任务状态实时更新
  - 进度回调机制
  - 错误处理和重试
  - _需求: 2.1, 2.2, 2.4, 2.5_

#### 2.3 任务模型
- [ ] 创建任务模型 `models/task.py`
  - Task类定义
  - 任务状态枚举
  - 任务数据序列化/反序列化
  - _需求: 2.1, 2.3, 2.4, 2.5_

#### 2.4 任务API
- [ ] 创建任务API `api/tasks.py`
  - POST /api/tasks/create - 创建任务
  - POST /api/tasks/{id}/upload - 上传文件
  - POST /api/tasks/{id}/config - 设置配置并开始处理
  - GET /api/tasks/{id}/status - 查询状态
  - GET /api/tasks/{id}/download - 下载结果
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 5.1, 5.2, 5.4_

### 阶段3: 存储系统设计 (1天)

#### 3.1 存储抽象接口
- [ ] 创建存储抽象接口 `core/storage/storage_interface.py`
  - 定义用户和任务数据操作接口
  - 支持未来数据库迁移
  - 统一的数据访问层
  - _需求: 7.1, 7.5_

#### 3.2 文件存储实现
- [ ] 创建文件存储实现 `core/storage/file_storage.py`
  - 实现存储接口的文件系统版本
  - 用户目录管理
  - 文件上传和保存
  - 文件下载权限验证
  - 过期文件清理
  - _需求: 4.4, 5.1, 5.2, 5.3, 5.5_

#### 3.3 文件工具类
- [ ] 创建文件工具 `utils/file_utils.py`
  - 文件类型验证
  - 文件大小检查
  - 安全文件名处理
  - 目录创建和管理
  - _需求: 5.1, 5.2, 5.3_

#### 3.4 UUID工具类
- [ ] 创建UUID工具 `utils/uuid_utils.py`
  - UUID生成和验证
  - 短ID生成（用于显示）
  - ID唯一性检查
  - _需求: 1.5_

### 阶段4: 视频处理器集成 (1天)

#### 4.1 水印处理器适配
- [ ] 修改水印处理器 `processors/watermark_processor.py`
  - 包装为异步任务
  - 添加进度回调
  - 错误处理和状态更新
  - 结果文件保存
  - _需求: 2.1, 2.2, 2.4, 2.5_

#### 4.2 视频合并器适配
- [ ] 修改视频合并器 `processors/video_merger.py`
  - 包装为异步任务
  - 添加进度回调
  - 错误处理和状态更新
  - 结果文件保存
  - _需求: 2.1, 2.2, 2.4, 2.5_

#### 4.3 处理器注册
- [ ] 创建处理器注册机制
  - 任务类型与处理器映射
  - 处理器生命周期管理
  - 处理器错误恢复
  - _需求: 2.1, 2.4, 2.5_

### 阶段5: 兼容性API层 (1天)

#### 5.1 视频API兼容层
- [ ] 创建视频API `api/video.py`
  - 保持原有API路径和响应格式
  - 内部调用新的任务管理系统
  - 响应格式转换
  - _需求: 保持兼容性_

#### 5.2 响应格式适配
- [ ] 实现响应格式转换
  - 新API格式 → 原有格式
  - 错误码映射
  - 数据结构转换
  - _需求: 保持兼容性_

### 阶段6: 前端任务管理界面 (2天)

#### 6.1 任务列表页面
- [ ] 创建任务列表页面 `pages/tasks.js`
  - 显示用户所有任务
  - 任务状态和进度显示
  - 任务操作按钮（下载、删除）
  - 实时状态更新
  - 支持多语言（中文/英文）
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

#### 6.2 任务详情页面
- [ ] 创建任务详情页面 `pages/tasks/[id].js`
  - 显示任务详细信息
  - 实时进度更新
  - 错误信息显示
  - 结果文件下载
  - 支持多语言（中文/英文）
  - _需求: 3.2, 3.3, 3.4, 3.5_

#### 6.3 任务管理组件
- [ ] 创建任务相关组件
  - TaskList组件 - 任务列表
  - TaskItem组件 - 任务项
  - TaskStatus组件 - 状态显示
  - ProgressBar组件 - 进度条
  - 所有组件支持多语言
  - _需求: 3.1, 3.2, 3.3_

#### 6.4 导航和路由
- [ ] 更新导航和路由
  - 添加"我的"主菜单，下设"任务列表"子菜单
  - 为未来商业化预留更多"我的"子菜单空间
  - 任务相关路由配置
  - 面包屑导航
  - _需求: 3.1_

### 阶段7: 现有页面集成 (1天)

#### 7.1 水印去除页面集成
- [ ] 修改水印去除页面流程
  - 任务提交后跳转到任务列表
  - 显示任务创建成功提示
  - 保持原有交互体验
  - _需求: 2.1, 2.2, 3.1_

#### 7.2 视频合并页面集成
- [ ] 修改视频合并页面流程
  - 任务提交后跳转到任务列表
  - 显示任务创建成功提示
  - 保持原有交互体验
  - _需求: 2.1, 2.2, 3.1_

#### 7.3 API调用更新
- [ ] 更新前端API调用
  - 添加withCredentials支持
  - 错误处理适配
  - 响应格式处理
  - _需求: 1.1, 1.2, 1.3_

### 阶段8: 系统资源管理 (1天)

#### 8.1 并发控制
- [ ] 实现并发任务控制
  - 单用户并发任务数限制（默认1个，可配置）
  - 系统总并发任务数限制（默认5个，可配置）
  - 配置文件管理并发参数
  - 任务提交时的并发检查
  - 相应的错误提示信息
  - _需求: 6.1, 6.2, 6.5_

#### 8.2 文件清理机制
- [ ] 实现自动文件清理
  - 过期任务清理
  - 临时文件清理
  - 存储空间监控
  - _需求: 5.3, 6.4_

#### 8.3 错误处理和恢复
- [ ] 实现错误处理机制
  - 任务超时处理
  - 系统重启恢复
  - 错误日志记录
  - _需求: 4.4, 6.3_

### 阶段9: 测试和优化 (1天)

#### 9.1 单元测试
- [ ] 编写单元测试
  - 用户管理器测试
  - 任务管理器测试
  - 文件存储测试
  - API接口测试
  - _需求: 所有功能需求_

#### 9.2 集成测试
- [ ] 编写集成测试
  - 完整任务流程测试
  - 用户会话持久化测试
  - 并发任务测试
  - 错误恢复测试
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

#### 9.3 性能优化
- [ ] 性能测试和优化
  - API响应时间优化
  - 文件I/O性能优化
  - 内存使用优化
  - 并发性能测试
  - _需求: 性能需求_

## 验收标准

### 功能验收
- [ ] 用户首次访问自动获得身份标识
- [ ] 用户可以提交任务后关闭浏览器
- [ ] 用户重新打开浏览器能看到历史任务
- [ ] 任务在后台正常处理并更新状态
- [ ] 用户只能访问自己的任务和文件
- [ ] 系统支持并发用户和任务

### 性能验收
- [ ] 任务提交响应时间 < 2秒
- [ ] 任务状态查询响应时间 < 1秒
- [ ] 支持至少10个并发用户
- [ ] 支持至少50个并发任务

### 稳定性验收
- [ ] 24小时连续运行无崩溃
- [ ] 任务失败有明确错误信息
- [ ] 系统重启后任务状态可恢复
- [ ] 文件存储安全可靠

---

**预计开发时间**: 9天  
**开发人员**: 1人  
**技术难度**: 中等  
**风险等级**: 低-中等