# 视频合并功能文档

## 🎯 功能概述

视频合并功能允许用户将多个视频文件合并为一个完整的视频文件，支持精确的时间片段选择和智能排序。

## ✨ 主要特性

### 核心功能
- **多文件上传**: 支持同时上传最多10个视频文件
- **时间片段选择**: 精确到秒的时间片段选择
- **智能缩略图**: 自动提取高质量视频帧作为预览
- **拖拽排序**: 支持拖拽调整视频合并顺序
- **实时计算**: 实时显示合并后的总时长
- **自动命名**: 基于时间戳的智能任务命名

### 技术特性
- **异步处理**: 后台异步处理，不阻塞用户操作
- **格式支持**: 支持主流视频格式（MP4, AVI, MOV, MKV等）
- **质量保证**: 保持原始视频质量
- **音视频同步**: 确保音频和视频完美同步

## 🚀 使用流程

### 1. 文件上传
```
用户选择多个视频文件 → 系统验证文件格式 → 上传到服务器
```

### 2. 时间片段设置
```
系统提取缩略图 → 用户设置开始/结束时间 → 实时预览效果
```

### 3. 顺序调整
```
拖拽视频卡片 → 调整合并顺序 → 更新总时长显示
```

### 4. 任务提交
```
确认设置 → 提交合并任务 → 跳转到任务详情页
```

### 5. 结果下载
```
异步处理完成 → 通知用户 → 下载合并后的视频
```

## 🛠️ 技术实现

### 前端实现
- **React组件**: 模块化的视频上传和编辑组件
- **拖拽功能**: 基于HTML5 Drag & Drop API
- **时间选择**: 自定义时间滑块组件
- **缩略图显示**: Canvas绘制视频帧预览

### 后端实现
- **文件处理**: Flask文件上传和存储管理
- **FFmpeg集成**: 视频处理和合并操作
- **任务队列**: 异步任务处理系统
- **状态管理**: 实时任务状态跟踪

### 数据流程
```
前端上传 → 后端存储 → FFmpeg处理 → 结果存储 → 用户下载
```

## 📋 API接口

### 创建合并任务
```http
POST /api/tasks/create
Content-Type: application/json

{
  "task_type": "video_merger",
  "task_name": "我的视频合并任务"
}
```

### 上传视频文件
```http
POST /api/tasks/{task_id}/upload
Content-Type: multipart/form-data

files: [video1.mp4, video2.mp4, ...]
```

### 设置时间片段
```http
PUT /api/tasks/{task_id}/segments/{file_index}
Content-Type: application/json

{
  "start_time": 10.5,
  "end_time": 120.3
}
```

### 开始合并处理
```http
POST /api/tasks/{task_id}/config
Content-Type: application/json

{
  "segments": [
    {"file_index": 0, "start_time": 0, "end_time": 60},
    {"file_index": 1, "start_time": 30, "end_time": 90}
  ]
}
```

### 获取任务状态
```http
GET /api/tasks/{task_id}/status

Response:
{
  "status": "processing",
  "progress": 45,
  "message": "正在合并视频..."
}
```

## 🎨 用户界面

### 上传界面
- 拖拽上传区域
- 文件列表显示
- 上传进度指示
- 格式验证提示

### 编辑界面
- 视频缩略图预览
- 时间轴滑块控制
- 总时长实时显示
- 拖拽排序功能

### 任务界面
- 任务状态显示
- 处理进度条
- 错误信息提示
- 下载链接

## 🔧 配置参数

### 文件限制
```python
MAX_FILES = 10              # 最大文件数量
MAX_FILE_SIZE = 500 * 1024 * 1024  # 单文件最大500MB
ALLOWED_EXTENSIONS = ['mp4', 'avi', 'mov', 'mkv', 'wmv']
```

### 处理参数
```python
THUMBNAIL_COUNT = 5         # 缩略图数量
THUMBNAIL_SIZE = (160, 90)  # 缩略图尺寸
VIDEO_CODEC = 'libx264'     # 视频编码器
AUDIO_CODEC = 'aac'         # 音频编码器
```

### 质量设置
```python
VIDEO_BITRATE = '2M'        # 视频比特率
AUDIO_BITRATE = '128k'      # 音频比特率
FRAME_RATE = 30             # 帧率
```

## 🧪 测试用例

### 功能测试
- [x] 单文件上传测试
- [x] 多文件上传测试
- [x] 时间片段设置测试
- [x] 拖拽排序测试
- [x] 合并处理测试
- [x] 下载功能测试

### 边界测试
- [x] 最大文件数量测试
- [x] 文件大小限制测试
- [x] 格式兼容性测试
- [x] 时间边界测试
- [x] 网络中断测试

### 性能测试
- [x] 大文件处理测试
- [x] 并发任务测试
- [x] 内存使用测试
- [x] 处理速度测试

## 🐛 已知问题

### 已修复
- ✅ 合并视频出现黑屏问题
- ✅ 音视频不同步问题
- ✅ 时间戳不准确问题
- ✅ 缩略图提取失败问题

### 待优化
- ⚠️ 大文件上传速度优化
- ⚠️ 批量任务处理支持
- ⚠️ 更多视频格式支持
- ⚠️ 视频质量自动调整

## 🔮 未来规划

### 短期计划
- 支持更多视频格式
- 添加视频转场效果
- 优化处理性能
- 增加批量操作

### 长期计划
- 视频编辑功能扩展
- 云端处理支持
- AI智能剪辑
- 协作编辑功能

## 📞 技术支持

如果在使用视频合并功能时遇到问题：
1. 检查视频文件格式是否支持
2. 确认文件大小在限制范围内
3. 查看任务状态和错误信息
4. 联系技术支持团队

---

**最后更新**: 2025年8月4日  
**功能版本**: v2.0  
**维护者**: MediaCraft 开发团队