<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediaCraft - Professional Video Watermark Removal Tool</title>
    <meta name="description" content="MediaCraft offers intelligent video watermark removal with AI technology. Remove watermarks from videos easily while preserving quality. Supports MP4, MOV, AVI, MKV formats.">
    <meta name="keywords" content="MediaCraft, video watermark removal, watermark remover, video editing tools, AI watermark removal, online video editing, professional video tools, remove logo from video">
    <meta property="og:title" content="MediaCraft - Professional Video Watermark Removal Tool">
    <meta property="og:description" content="Remove watermarks from videos easily while preserving quality. Powered by AI technology.">
    <meta property="og:url" content="https://mediacraft.yzhu.name/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="MediaCraft - Professional Video Watermark Removal Tool">
    <meta name="twitter:description" content="Remove watermarks from videos easily while preserving quality. Powered by AI technology.">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">

    <style>
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #0d6efd;
            background-color: #f8f9ff;
        }
        .frame-selector {
            max-height: 400px;
            overflow-y: auto;
        }
        .frame-item {
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .frame-item:hover {
            border-color: #0d6efd;
        }
        .frame-item.selected {
            border-color: #198754;
            background-color: #d1e7dd;
        }
        .frame-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
        }
        .region-canvas {
            border: 1px solid #dee2e6;
            cursor: crosshair;
            max-width: 100%;
            height: auto;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .step {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #6c757d;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-weight: bold;
        }
        .step.active .step-number {
            background-color: #0d6efd;
        }
        .step.completed .step-number {
            background-color: #198754;
        }
        .region-list {
            max-height: 200px;
            overflow-y: auto;
        }
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        main {
            flex: 1;
        }
        .header-title {
            font-size: 1.5rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <header class="bg-light p-3 border-bottom">
        <div class="container">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMwZDZlZmQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTIgMnYyMCIvPjxwYXRoIGQ9Ik0xNyA1SDlsLTIgNSAyIDUgNCAyIDQtMiAyLTUtMi01eiIvPjwvc3ZnPg==" alt="MediaCraft Logo" width="40" height="40" class="me-2">
                    <h1 class="header-title m-0">MediaCraft</h1>
                </div>
                <div class="d-none d-md-block">
                    <span class="badge bg-primary">Video Watermark Remover</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container my-5">
        <!-- Introduction Section -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-7">
                        <h2>Professional Video Watermark Removal</h2>
                        <p class="lead">Remove unwanted watermarks from your videos while preserving quality.</p>
                        <p>MediaCraft's advanced AI technology intelligently detects and removes watermarks, logos, and text overlays from your videos. Our tool is designed for content creators, marketers, and video professionals who need clean, watermark-free videos.</p>
                        <div class="d-flex flex-wrap gap-2 mt-3">
                            <div class="badge bg-light text-dark p-2"><i class="bi bi-check-circle text-success me-1"></i> High Quality Results</div>
                            <div class="badge bg-light text-dark p-2"><i class="bi bi-check-circle text-success me-1"></i> Multiple Video Formats</div>
                            <div class="badge bg-light text-dark p-2"><i class="bi bi-check-circle text-success me-1"></i> Preserves Audio</div>
                            <div class="badge bg-light text-dark p-2"><i class="bi bi-check-circle text-success me-1"></i> Easy to Use</div>
                        </div>
                    </div>
                    <div class="col-md-5 mt-3 mt-md-0 text-center">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzBkNmVmZCIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiByeD0iMi41IiByeT0iMi41Ij48L3JlY3Q+PGxpbmUgeDE9IjciIHkxPSIyIiB4Mj0iNyIgeTI9IjIyIj48L2xpbmU+PGxpbmUgeDE9IjE3IiB5MT0iMiIgeDI9IjE3IiB5Mj0iMjIiPjwvbGluZT48bGluZSB4MT0iMiIgeTE9IjEyIiB4Mj0iMjIiIHkyPSIxMiI+PC9saW5lPjxsaW5lIHgxPSIyIiB5MT0iNyIgeDI9IjciIHkyPSI3Ij48L2xpbmU+PGxpbmUgeDE9IjIiIHkxPSIxNyIgeDI9IjciIHkyPSIxNyI+PC9saW5lPjxsaW5lIHgxPSIxNyIgeTE9IjE3IiB4Mj0iMjIiIHkyPSIxNyI+PC9saW5lPjxsaW5lIHgxPSIxNyIgeTE9IjciIHgyPSIyMiIgeTI9IjciPjwvbGluZT48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIzIj48L2NpcmNsZT48bGluZSB4MT0iMTAiIHkxPSI3IiB4Mj0iMTQiIHkyPSI3IiBzdHJva2U9IiNkYzM1NDUiIHN0cm9rZS13aWR0aD0iMiI+PC9saW5lPjwvc3ZnPg==" alt="Video Watermark Removal Illustration" class="img-fluid" style="max-width: 200px;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step-upload">
                <div class="step-number">1</div>
                <span>Upload Video</span>
            </div>
            <div class="step" id="step-frame">
                <div class="step-number">2</div>
                <span>Select Frame</span>
            </div>
            <div class="step" id="step-region">
                <div class="step-number">3</div>
                <span>Mark Watermarks</span>
            </div>
            <div class="step" id="step-process">
                <div class="step-number">4</div>
                <span>Process Complete</span>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alert-container"></div>

        <!-- Step 1: Upload Video -->
        <div id="upload-section" class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Step 1: Upload Video File</h5>
            </div>
            <div class="card-body">
                <div class="upload-area" id="upload-area">
                    <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                    <h5 class="mt-3">Drag and drop video file here, or click to select</h5>
                    <p class="text-muted">Supports MP4, MOV, AVI, MKV formats, max 500MB</p>
                    <input type="file" id="video-input" accept="video/*" style="display: none;">
                </div>
                <div class="mt-3" id="upload-info" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong id="file-name"></strong>
                            <div class="text-muted small">
                                <span id="file-size"></span> | 
                                <span id="file-duration"></span> | 
                                <span id="file-resolution"></span>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="next-to-frame">Next: Select Frame</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Select Frame -->
        <div id="frame-section" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">Step 2: Select Frame with Watermark</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Please select a frame that clearly shows the watermark(s) you want to remove.</p>
                <div class="frame-selector" id="frame-selector">
                    <div class="row" id="frames-container">
                        <!-- Frame thumbnails will be generated here -->
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <button class="btn btn-secondary me-2" id="back-to-upload">Previous</button>
                    <button class="btn btn-primary" id="next-to-region" disabled>Next: Mark Watermarks</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Mark Watermark Regions -->
        <div id="region-section" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">Step 3: Mark Watermark Regions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <p class="text-muted">Drag your mouse on the image to select watermark regions. You can select multiple regions.</p>
                        <div class="text-center">
                            <canvas id="region-canvas" class="region-canvas"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Selected Watermark Regions:</h6>
                        <div class="region-list" id="region-list">
                            <p class="text-muted">No regions selected yet</p>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-warning btn-sm" id="clear-regions">Clear All Regions</button>
                        </div>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <button class="btn btn-secondary me-2" id="back-to-frame">Previous</button>
                    <button class="btn btn-success" id="start-processing" disabled>Start Processing</button>
                </div>
            </div>
        </div>

        <!-- FAQ Section for SEO -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Frequently Asked Questions</h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="faqAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="faqOne">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                How does MediaCraft remove watermarks from videos?
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="faqOne" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                MediaCraft uses advanced AI-powered image inpainting technology to intelligently remove watermarks from videos. The process involves analyzing the selected frame, identifying the watermark regions, and then applying sophisticated algorithms to reconstruct the original content underneath the watermark. This technology ensures that the removed watermark area blends seamlessly with the surrounding video content.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="faqTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                What video formats are supported?
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="faqTwo" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                MediaCraft supports all major video formats including MP4, MOV, AVI, and MKV. The maximum file size for upload is 500MB. If your video is larger, consider compressing it first or trimming it to the essential parts before uploading.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="faqThree">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                Is the original audio preserved in the processed video?
                            </button>
                        </h2>
                        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="faqThree" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Yes, MediaCraft preserves the original audio track of your video. Our processing focuses only on the visual elements, specifically the watermark regions you select. The audio quality remains unchanged in the final output.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="faqFour">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                                Can MediaCraft remove dynamic or moving watermarks?
                            </button>
                        </h2>
                        <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="faqFour" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                The current version of MediaCraft is optimized for static watermarks that appear in the same position throughout the video. For videos with moving watermarks, we recommend selecting the most representative frame and marking the watermark regions carefully. In many cases, our technology can still achieve good results with semi-dynamic watermarks.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="faqFive">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                                Is my video data secure when using MediaCraft?
                            </button>
                        </h2>
                        <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="faqFive" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Yes, we take data security seriously. Your uploaded videos are processed on secure servers and are automatically deleted after processing is complete. We do not store your videos permanently, and all processing is done in a secure environment. Your processed videos are available for download for a limited time only.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Processing Progress and Results -->
        <div id="process-section" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">Step 4: Video Processing</h5>
            </div>
            <div class="card-body">
                <div id="processing-status">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <h5 class="mt-3">Processing video, please wait...</h5>
                        <p class="text-muted" id="processing-message">Initializing processing task</p>
                    </div>
                    <div class="progress mt-3">
                        <div class="progress-bar" role="progressbar" style="width: 0%" id="progress-bar">0%</div>
                    </div>
                </div>
                
                <div id="processing-complete" style="display: none;">
                    <div class="text-center">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-success">Video Processing Complete!</h5>
                        <p class="text-muted">Your video has been successfully processed and watermarks removed.</p>
                        <button class="btn btn-success btn-lg" id="download-result">
                            <i class="bi bi-download"></i> Download Processed Video
                        </button>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary" id="process-another">Process Another Video</button>
                        </div>
                    </div>
                </div>

                <div id="processing-error" style="display: none;">
                    <div class="text-center">
                        <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-danger">Processing Failed</h5>
                        <p class="text-muted" id="error-message">An error occurred during processing</p>
                        <button class="btn btn-primary" id="retry-processing">Retry</button>
                        <button class="btn btn-outline-secondary ms-2" id="start-over">Start Over</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-light p-3 border-top">
        <div class="container">
            <div class="row">
                <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                    <div class="d-flex align-items-center">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMwZDZlZmQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTIgMnYyMCIvPjxwYXRoIGQ9Ik0xNyA1SDlsLTIgNSAyIDUgNCAyIDQtMiAyLTUtMi01eiIvPjwvc3ZnPg==" alt="MediaCraft Logo" width="30" height="30" class="me-2">
                        <span class="fw-bold">MediaCraft</span>
                    </div>
                    <p class="text-muted small mt-2 mb-0">&copy; 2025 MediaCraft. All rights reserved.</p>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <div class="mb-2">
                        <a href="#" class="text-decoration-none text-muted small me-3">Terms of Service</a>
                        <a href="#" class="text-decoration-none text-muted small me-3">Privacy Policy</a>
                        <a href="#" class="text-decoration-none text-muted small">Contact</a>
                    </div>
                    <p class="text-muted small mb-0">Powered by advanced AI technology</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "MediaCraft Video Watermark Remover",
      "applicationCategory": "MultimediaApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "description": "Professional video watermark removal tool that uses AI technology to remove watermarks, logos, and text overlays from videos while preserving quality.",
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "156"
      },
      "featureList": "High Quality Results, Multiple Video Formats Support, Audio Preservation, Easy to Use Interface",
      "url": "https://mediacraft.yzhu.name/"
    }
    </script>

    <script>
        // Global variables
        let currentTaskUuid = null;
        let selectedFrameNumber = null;
        let selectedRegions = [];
        let isDrawing = false;
        let startX, startY;
        let canvas, ctx;
        let frameImage = null;

        // DOM elements
        const uploadArea = document.getElementById('upload-area');
        const videoInput = document.getElementById('video-input');
        const uploadInfo = document.getElementById('upload-info');
        const alertContainer = document.getElementById('alert-container');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
        });

        function initializeEventListeners() {
            // Upload related events
            uploadArea.addEventListener('click', () => videoInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            videoInput.addEventListener('change', handleFileSelect);

            // Navigation button events
            document.getElementById('next-to-frame').addEventListener('click', loadVideoFrames);
            document.getElementById('back-to-upload').addEventListener('click', () => showSection('upload'));
            document.getElementById('next-to-region').addEventListener('click', loadSelectedFrame);
            document.getElementById('back-to-frame').addEventListener('click', () => showSection('frame'));
            document.getElementById('start-processing').addEventListener('click', startVideoProcessing);

            // Region selection related events
            document.getElementById('clear-regions').addEventListener('click', clearAllRegions);
            document.getElementById('download-result').addEventListener('click', downloadResult);
            document.getElementById('process-another').addEventListener('click', resetApplication);
            document.getElementById('start-over').addEventListener('click', resetApplication);
            document.getElementById('retry-processing').addEventListener('click', startVideoProcessing);
        }

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // Validate file type
            const allowedTypes = ['video/mp4', 'video/mov', 'video/avi', 'video/x-msvideo', 'video/x-matroska'];
            if (!allowedTypes.includes(file.type)) {
                showAlert('Please select a valid video file (MP4, MOV, AVI, MKV)', 'danger');
                return;
            }

            // Validate file size (500MB)
            if (file.size > 500 * 1024 * 1024) {
                showAlert('File size cannot exceed 500MB', 'danger');
                return;
            }

            uploadVideo(file);
        }

        async function uploadVideo(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                showAlert('Uploading video...', 'info');
                
                const response = await fetch('/api/video/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.code === 10000) {
                    currentTaskUuid = result.data.task_uuid;
                    displayUploadInfo(result.data);
                    showAlert('Video uploaded successfully!', 'success');
                } else {
                    showAlert(result.message || 'Upload failed', 'danger');
                }
            } catch (error) {
                showAlert('Error occurred during upload: ' + error.message, 'danger');
            }
        }

        function displayUploadInfo(data) {
            document.getElementById('file-name').textContent = data.filename;
            document.getElementById('file-size').textContent = formatFileSize(data.file_size);
            document.getElementById('file-duration').textContent = formatDuration(data.duration);
            document.getElementById('file-resolution').textContent = data.resolution || 'Unknown';
            uploadInfo.style.display = 'block';
        }

        async function loadVideoFrames() {
            if (!currentTaskUuid) return;

            try {
                showAlert('Extracting video frames...', 'info');
                
                const response = await fetch(`/api/video/task/${currentTaskUuid}/frames?count=12`);
                const result = await response.json();

                if (result.code === 10000) {
                    displayFrames(result.data.frames);
                    showSection('frame');
                    updateStepIndicator('frame');
                    clearAlert();
                } else {
                    showAlert(result.message || 'Failed to extract video frames', 'danger');
                }
            } catch (error) {
                showAlert('Error occurred while extracting frames: ' + error.message, 'danger');
            }
        }

        function displayFrames(frames) {
            const container = document.getElementById('frames-container');
            container.innerHTML = '';

            frames.forEach((frame, index) => {
                const frameDiv = document.createElement('div');
                frameDiv.className = 'col-md-3 col-sm-4 col-6 mb-3';
                frameDiv.innerHTML = `
                    <div class="frame-item p-2" data-frame-number="${frame.frame_number}">
                        <img src="${frame.image_data}" alt="Frame ${frame.frame_number}" class="frame-image">
                        <div class="text-center mt-1">
                            <small class="text-muted">Frame ${frame.frame_number}</small>
                        </div>
                    </div>
                `;

                frameDiv.addEventListener('click', () => selectFrame(frame.frame_number, frameDiv));
                container.appendChild(frameDiv);
            });
        }

        function selectFrame(frameNumber, element) {
            // Remove previous selection
            document.querySelectorAll('.frame-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Select current frame
            element.querySelector('.frame-item').classList.add('selected');
            selectedFrameNumber = frameNumber;
            document.getElementById('next-to-region').disabled = false;
        }

        async function loadSelectedFrame() {
            if (!currentTaskUuid || !selectedFrameNumber) return;

            try {
                showAlert('Loading selected frame...', 'info');
                
                const response = await fetch(`/api/video/task/${currentTaskUuid}/select-frame`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        frame_number: selectedFrameNumber
                    })
                });

                const result = await response.json();

                if (result.code === 10000) {
                    setupRegionSelection(result.data.frame_image);
                    showSection('region');
                    updateStepIndicator('region');
                    clearAlert();
                } else {
                    showAlert(result.message || 'Failed to load frame', 'danger');
                }
            } catch (error) {
                showAlert('Error occurred while loading frame: ' + error.message, 'danger');
            }
        }

        function setupRegionSelection(frameImageData) {
            canvas = document.getElementById('region-canvas');
            ctx = canvas.getContext('2d');

            frameImage = new Image();
            frameImage.onload = function() {
                // Set canvas size
                const maxWidth = 600;
                const scale = Math.min(maxWidth / frameImage.width, 1);
                canvas.width = frameImage.width * scale;
                canvas.height = frameImage.height * scale;

                // Draw image
                ctx.drawImage(frameImage, 0, 0, canvas.width, canvas.height);

                // Add mouse events
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', drawRegion);
                canvas.addEventListener('mouseup', endDrawing);
            };
            frameImage.src = frameImageData;
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
        }

        function drawRegion(e) {
            if (!isDrawing) return;

            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            // Redraw image
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(frameImage, 0, 0, canvas.width, canvas.height);

            // Draw existing regions
            selectedRegions.forEach(region => {
                ctx.strokeStyle = '#dc3545';
                ctx.lineWidth = 2;
                ctx.strokeRect(region.x, region.y, region.width, region.height);
            });

            // Draw current region being drawn
            ctx.strokeStyle = '#0d6efd';
            ctx.lineWidth = 2;
            ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
        }

        function endDrawing(e) {
            if (!isDrawing) return;
            isDrawing = false;

            const rect = canvas.getBoundingClientRect();
            const endX = e.clientX - rect.left;
            const endY = e.clientY - rect.top;

            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);

            // Only add region if it's large enough
            if (width > 10 && height > 10) {
                const region = {
                    x: Math.min(startX, endX),
                    y: Math.min(startY, endY),
                    width: width,
                    height: height
                };

                // Convert to original image coordinates
                const scaleX = frameImage.width / canvas.width;
                const scaleY = frameImage.height / canvas.height;
                
                const originalRegion = {
                    x: Math.round(region.x * scaleX),
                    y: Math.round(region.y * scaleY),
                    width: Math.round(region.width * scaleX),
                    height: Math.round(region.height * scaleY)
                };

                selectedRegions.push(originalRegion);
                updateRegionList();
                redrawCanvas();
                
                document.getElementById('start-processing').disabled = selectedRegions.length === 0;
            }
        }

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(frameImage, 0, 0, canvas.width, canvas.height);

            // Draw all regions
            selectedRegions.forEach((region, index) => {
                const scaleX = canvas.width / frameImage.width;
                const scaleY = canvas.height / frameImage.height;
                
                const x = region.x * scaleX;
                const y = region.y * scaleY;
                const width = region.width * scaleX;
                const height = region.height * scaleY;

                ctx.strokeStyle = '#dc3545';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, width, height);

                // Add region number
                ctx.fillStyle = '#dc3545';
                ctx.font = '14px Arial';
                ctx.fillText(`${index + 1}`, x + 5, y + 20);
            });
        }

        function updateRegionList() {
            const regionList = document.getElementById('region-list');
            
            if (selectedRegions.length === 0) {
                regionList.innerHTML = '<p class="text-muted">No regions selected yet</p>';
                return;
            }

            let html = '';
            selectedRegions.forEach((region, index) => {
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <span>Region ${index + 1}: ${region.width}×${region.height}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeRegion(${index})">Remove</button>
                    </div>
                `;
            });
            regionList.innerHTML = html;
        }

        function removeRegion(index) {
            selectedRegions.splice(index, 1);
            updateRegionList();
            redrawCanvas();
            document.getElementById('start-processing').disabled = selectedRegions.length === 0;
        }

        function clearAllRegions() {
            selectedRegions = [];
            updateRegionList();
            redrawCanvas();
            document.getElementById('start-processing').disabled = true;
        }

        async function startVideoProcessing() {
            if (!currentTaskUuid || selectedRegions.length === 0) return;

            try {
                const response = await fetch(`/api/video/task/${currentTaskUuid}/select-regions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        regions: selectedRegions
                    })
                });

                const result = await response.json();

                if (result.code === 10000) {
                    showSection('process');
                    updateStepIndicator('process');
                    startProgressPolling();
                } else {
                    showAlert(result.message || 'Failed to start processing', 'danger');
                }
            } catch (error) {
                showAlert('Error occurred while starting processing: ' + error.message, 'danger');
            }
        }

        function startProgressPolling() {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/video/task/${currentTaskUuid}/status`);
                    const result = await response.json();

                    if (result.code === 10000) {
                        const status = result.data.status;
                        const progress = result.data.progress_percentage;

                        updateProgress(progress);

                        if (status === 'completed') {
                            clearInterval(pollInterval);
                            showProcessingComplete();
                        } else if (status === 'failed') {
                            clearInterval(pollInterval);
                            showProcessingError(result.data.error_message);
                        }
                    }
                } catch (error) {
                    console.error('Failed to poll status:', error);
                }
            }, 2000);
        }

        function updateProgress(percentage) {
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';

            let message = 'Processing video...';
            if (percentage < 20) {
                message = 'Initializing processing task...';
            } else if (percentage < 80) {
                message = 'Removing watermarks...';
            } else if (percentage < 100) {
                message = 'Merging audio...';
            }

            document.getElementById('processing-message').textContent = message;
        }

        function showProcessingComplete() {
            document.getElementById('processing-status').style.display = 'none';
            document.getElementById('processing-complete').style.display = 'block';
            updateStepIndicator('completed');
        }

        function showProcessingError(errorMessage) {
            document.getElementById('processing-status').style.display = 'none';
            document.getElementById('error-message').textContent = errorMessage || 'An unknown error occurred during processing';
            document.getElementById('processing-error').style.display = 'block';
        }

        async function downloadResult() {
            if (!currentTaskUuid) return;

            try {
                const response = await fetch(`/api/video/task/${currentTaskUuid}/download`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'video_no_watermark.mp4';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const result = await response.json();
                    showAlert(result.message || 'Download failed', 'danger');
                }
            } catch (error) {
                showAlert('Error occurred during download: ' + error.message, 'danger');
            }
        }

        function resetApplication() {
            currentTaskUuid = null;
            selectedFrameNumber = null;
            selectedRegions = [];
            uploadInfo.style.display = 'none';
            videoInput.value = '';
            showSection('upload');
            updateStepIndicator('upload');
            clearAlert();
        }

        function showSection(sectionName) {
            const sections = ['upload', 'frame', 'region', 'process'];
            sections.forEach(section => {
                document.getElementById(`${section}-section`).style.display = 
                    section === sectionName ? 'block' : 'none';
            });
        }

        function updateStepIndicator(currentStep) {
            const steps = ['upload', 'frame', 'region', 'process'];
            const stepElements = {
                'upload': 'step-upload',
                'frame': 'step-frame', 
                'region': 'step-region',
                'process': 'step-process'
            };

            steps.forEach(step => {
                const element = document.getElementById(stepElements[step]);
                element.classList.remove('active', 'completed');
                
                if (step === currentStep) {
                    element.classList.add('active');
                } else if (steps.indexOf(step) < steps.indexOf(currentStep)) {
                    element.classList.add('completed');
                }
            });

            if (currentStep === 'completed') {
                document.getElementById('step-process').classList.remove('active');
                document.getElementById('step-process').classList.add('completed');
            }
        }

        function showAlert(message, type) {
            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        function clearAlert() {
            alertContainer.innerHTML = '';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDuration(seconds) {
            if (!seconds) return 'Unknown';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>